class <%= migration_class_name %> < ActiveRecord::Migration<%= migration_version %>
  def change
    add_column :<%= table_name %>, :<%= attribute_name %>, :datetime
<% if add_index? -%>

    add_index :<%= table_name %>, :<%= attribute_name %>
<% end -%>
<% if add_not_null? -%>

    # Add NOT NULL constraint (reversible)
    change_column_null :<%= table_name %>, :<%= attribute_name %>, false
<% end -%>
<% if add_check_constraint? -%>

    # Add CHECK constraint to prevent future timestamps (PostgreSQL)
    reversible do |dir|
      dir.up do
        execute <<-SQL
          ALTER TABLE <%= table_name %>
          ADD CONSTRAINT <%= constraint_name %>
          CHECK (<%= attribute_name %> <= CURRENT_TIMESTAMP)
        SQL
      end

      dir.down do
        execute <<-SQL
          ALTER TABLE <%= table_name %>
          DROP CONSTRAINT IF EXISTS <%= constraint_name %>
        SQL
      end
    end
<% end -%>
  end
end
